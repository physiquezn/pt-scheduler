<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>Physiquezn PT Scheduler Vf5</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: #ffffff;
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background-color: #2b2b2b;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    h1 {
      text-align: center;
      color: #ff4d4d;
    }
    label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    textarea {
      width: 100%;
      background-color: #1e1e1e;
      color: #f0f0f0;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 1rem;
      font-size: 1rem;
      margin-bottom: 1rem;
      box-sizing: border-box;
    }
    button {
      background-color: #3a3a3a;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      display: block;
      margin: 0 auto;
    }
    button:hover {
      background-color: #555;
    }
    #output {
      margin-top: 2rem;
      white-space: pre-wrap;
    }
    footer {
      margin-top: 3rem;
      text-align: center;
      color: #aaa;
      font-size: 0.9rem;
    }
  </style>
  <script>
    const days = ['월', '화', '수', '목', '금'];

    function parseTimeRange(rangeStr) {
      if (rangeStr.includes('~') || rangeStr.includes('-')) {
        const [start, end] = rangeStr.split(/~|-/).map(Number);
        return Array.from({ length: end - start + 1 }, (_, i) => start + i);
      }
      return [Number(rangeStr)];
    }

    function preprocessTimeBlocks(raw) {
      const tokens = raw.split(',').map(t => t.trim());
      const blocks = [];
      let currentDays = [];

      tokens.forEach(token => {
        const comboMatch = token.match(/^([월화수목금]+)\s*(\d+(?:~\d+)?)/);
        const dayOnly = token.match(/^[월화수목금]+$/);
        const timeOnly = token.match(/^\d+(?:~\d+)?$/);

        if (comboMatch) {
          const [_, dStr, tStr] = comboMatch;
          const hours = parseTimeRange(tStr);
          dStr.split('').forEach(d => {
            hours.forEach(h => blocks.push({ day: d, hour: h }));
          });
        } else if (dayOnly) {
          currentDays = token.split('');
        } else if (timeOnly && currentDays.length > 0) {
          const hours = parseTimeRange(token);
          currentDays.forEach(d => {
            hours.forEach(h => blocks.push({ day: d, hour: h }));
          });
          currentDays = [];
        }
      });

      return blocks;
    }

    function parseInput(inputText, blockedText) {
      const blocked = preprocessTimeBlocks(blockedText);
      const blockedSet = new Set(blocked.map(({ day, hour }) => `${day}-${hour}`));

      const lines = inputText.trim().split('\n');
      const requests = [];

      lines.forEach(line => {
        const [nameRaw, countRaw, ...timeParts] = line.split('/').map(s => s.trim());
        const count = parseInt(countRaw.replace(/[^0-9]/g, ''));
        const timeStr = timeParts.join(',');
        const slots = preprocessTimeBlocks(timeStr);
        const filteredSlots = slots.filter(({ day, hour }) => !blockedSet.has(`${day}-${hour}`));

        const availability = {};
        filteredSlots.forEach(({ day, hour }) => {
          if (!availability[day]) availability[day] = [];
          availability[day].push(hour);
        });

        const isFixed = filteredSlots.length === count;
        requests.push({ name: nameRaw, count, availability, isFixed });
      });

      return requests;
    }

    function generateSchedule() {
      const input = document.getElementById("input").value;
      const blocked = document.getElementById("blocked").value;
      const parsed = parseInput(input, blocked);
      document.getElementById("output").textContent =
        "[디버그] 차단 시간 적용 후 회원 요청 목록:\n" + JSON.stringify(parsed, null, 2);
    }
  
    function assignSchedule(requests) {
      const schedule = {};
      const result = {};
      const days = ['월', '화', '수', '목', '금'];
      const hours = Array.from({ length: 9 }, (_, i) => 14 + i); // 14~22시

      // 초기화
      days.forEach(day => {
        schedule[day] = {};
        hours.forEach(hour => {
          schedule[day][hour] = null;
        });
      });

      // 요청 정렬: 고정 > 선택폭 좁은 순 > 랜덤
      requests.sort((a, b) => {
        if (a.isFixed !== b.isFixed) return b.isFixed - a.isFixed;
        const aCount = Object.values(a.availability).reduce((sum, arr) => sum + arr.length, 0);
        const bCount = Object.values(b.availability).reduce((sum, arr) => sum + arr.length, 0);
        if (aCount !== bCount) return aCount - bCount;
        return Math.random() - 0.5;
      });

      for (const req of requests) {
        result[req.name] = [];
        const usedDays = new Set();
        const allSlots = [];

        for (const day in req.availability) {
          for (const hour of req.availability[day]) {
            allSlots.push({ day, hour });
          }
        }

        if (!req.isFixed) {
          for (let i = allSlots.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allSlots[i], allSlots[j]] = [allSlots[j], allSlots[i]];
          }
        }

        let count = 0;
        for (const { day, hour } of allSlots) {
          if (count >= req.count) break;
          if (schedule[day][hour] === null && !usedDays.has(day)) {
            schedule[day][hour] = req.name;
            result[req.name].push(`${day} ${hour}시`);
            usedDays.add(day);
            count++;
          }
        }
      }

      return { schedule, result };
    }

    function generateSchedule() {
      const input = document.getElementById("input").value;
      const blocked = document.getElementById("blocked").value;
      const parsed = parseInput(input, blocked);
      const { schedule, result } = assignSchedule(parsed);

      const days = ['월', '화', '수', '목', '금'];
      const hours = Array.from({ length: 9 }, (_, i) => 14 + i);
      let output = '<h3>🗓️ 배정 요약</h3><ul>';
      for (const name in result) {
        const slots = result[name];
        output += `<li>${name}: ${slots.length}회 (${slots.join(', ')})</li>`;
      }
      output += '</ul><h3>📅 시간표</h3><table><thead><tr><th>시간</th>';
      days.forEach(day => output += `<th>${day}</th>`);
      output += '</tr></thead><tbody>';
      hours.forEach(hour => {
        output += `<tr><td>${hour}:00</td>`;
        days.forEach(day => {
          const cell = schedule[day][hour];
          output += `<td class="${cell ? 'highlight' : ''}">${cell || '-'}</td>`;
        });
        output += '</tr>';
      });
      output += '</tbody></table>';
      document.getElementById("output").innerHTML = output;
    }

  
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function assignSchedule(requests) {
      const schedule = {};
      const result = {};
      const days = ['월', '화', '수', '목', '금'];
      const hours = Array.from({ length: 9 }, (_, i) => 14 + i);

      days.forEach(day => {
        schedule[day] = {};
        hours.forEach(hour => {
          schedule[day][hour] = null;
        });
      });

      requests.sort((a, b) => {
        if (a.isFixed !== b.isFixed) return b.isFixed - a.isFixed;
        const aCount = Object.values(a.availability).reduce((sum, arr) => sum + arr.length, 0);
        const bCount = Object.values(b.availability).reduce((sum, arr) => sum + arr.length, 0);
        if (aCount !== bCount) return aCount - bCount;
        return Math.random() - 0.5;
      });

      for (const req of requests) {
        result[req.name] = [];
        const usedDays = new Set();
        let allSlots = [];

        for (const day in req.availability) {
          for (const hour of req.availability[day]) {
            allSlots.push({ day, hour });
          }
        }

        if (!req.isFixed) shuffleArray(allSlots);
        else allSlots.sort((a, b) => a.day.localeCompare(b.day) || a.hour - b.hour);

        let count = 0;
        for (const { day, hour } of allSlots) {
          if (count >= req.count) break;
          if (schedule[day][hour] === null && !usedDays.has(day)) {
            schedule[day][hour] = req.name;
            result[req.name].push(`${day} ${hour}시`);
            usedDays.add(day);
            count++;
          }
        }
      }

      return { schedule, result };
    }

    function generateSchedule() {
      const input = document.getElementById("input").value;
      const blocked = document.getElementById("blocked").value;
      const parsed = parseInput(input, blocked);
      const { schedule, result } = assignSchedule(parsed);

      const days = ['월', '화', '수', '목', '금'];
      const hours = Array.from({ length: 9 }, (_, i) => 14 + i);
      let output = '<h3>🗓️ 배정 요약</h3><ul>';
      for (const name in result) {
        const slots = result[name];
        output += `<li>${name}: ${slots.length}회 (${slots.join(', ')})</li>`;
      }
      output += '</ul><h3>📅 시간표</h3><table><thead><tr><th>시간</th>';
      days.forEach(day => output += `<th>${day}</th>`);
      output += '</tr></thead><tbody>';
      hours.forEach(hour => {
        output += `<tr><td>${hour}:00</td>`;
        days.forEach(day => {
          const cell = schedule[day][hour];
          output += `<td class="${cell ? 'highlight' : ''}">${cell || '-'}</td>`;
        });
        output += '</tr>';
      });
      output += '</tbody></table>';
      document.getElementById("output").innerHTML = output;
    }

  
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function assignSchedule(requests) {
      const schedule = {};
      const result = {};
      const days = ['월', '화', '수', '목', '금'];
      const hours = Array.from({ length: 9 }, (_, i) => 14 + i);

      days.forEach(day => {
        schedule[day] = {};
        hours.forEach(hour => {
          schedule[day][hour] = null;
        });
      });

      requests.sort((a, b) => {
        if (a.isFixed !== b.isFixed) return b.isFixed - a.isFixed;
        const aCount = Object.values(a.availability).reduce((sum, arr) => sum + arr.length, 0);
        const bCount = Object.values(b.availability).reduce((sum, arr) => sum + arr.length, 0);
        if (aCount !== bCount) return aCount - bCount;
        return Math.random() - 0.5;
      });

      for (const req of requests) {
        result[req.name] = [];
        const usedDays = new Set();
        let allSlots = [];

        for (const day of days) {
          if (req.availability[day]) {
            req.availability[day].forEach(hour => {
              allSlots.push({ day, hour });
            });
          }
        }

        if (!req.isFixed) shuffleArray(allSlots);

        let count = 0;
        for (const { day, hour } of allSlots) {
          if (count >= req.count) break;
          if (schedule[day][hour] === null && !usedDays.has(day)) {
            schedule[day][hour] = req.name;
            result[req.name].push(`${day} ${hour}시`);
            usedDays.add(day);
            count++;
          }
        }
      }

      return { schedule, result };
    }

    function generateSchedule() {
      const input = document.getElementById("input").value;
      const blocked = document.getElementById("blocked").value;
      const parsed = parseInput(input, blocked);
      const { schedule, result } = assignSchedule(parsed);

      const days = ['월', '화', '수', '목', '금'];
      const hours = Array.from({ length: 9 }, (_, i) => 14 + i);
      let output = '<h3>🗓️ 배정 요약</h3><ul>';
      for (const name in result) {
        const slots = result[name];
        output += `<li>${name}: ${slots.length}회 (${slots.join(', ')})</li>`;
      }
      output += '</ul><h3>📅 시간표</h3><table><thead><tr><th>시간</th>';
      days.forEach(day => output += `<th>${day}</th>`);
      output += '</tr></thead><tbody>';
      hours.forEach(hour => {
        output += `<tr><td>${hour}:00</td>`;
        days.forEach(day => {
          const cell = schedule[day][hour];
          output += `<td class="${cell ? 'highlight' : ''}">${cell || '-'}</td>`;
        });
        output += '</tr>';
      });
      output += '</tbody></table>';
      document.getElementById("output").innerHTML = output;
    }

  
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function assignSchedule(requests) {
      const schedule = {};
      const result = {};
      const days = ['월', '화', '수', '목', '금'];
      const hours = Array.from({ length: 9 }, (_, i) => 14 + i);

      days.forEach(day => {
        schedule[day] = {};
        hours.forEach(hour => {
          schedule[day][hour] = null;
        });
      });

      requests.sort((a, b) => {
        if (a.isFixed !== b.isFixed) return b.isFixed - a.isFixed;
        const aCount = Object.values(a.availability).reduce((sum, arr) => sum + arr.length, 0);
        const bCount = Object.values(b.availability).reduce((sum, arr) => sum + arr.length, 0);
        if (aCount !== bCount) return aCount - bCount;
        return Math.random() - 0.5;
      });

      for (const req of requests) {
        result[req.name] = [];
        const usedDays = new Set();
        const orderedSlots = [];

        for (const day of days) {
          if (req.availability[day]) {
            req.availability[day].forEach(hour => {
              orderedSlots.push({ day, hour });
            });
          }
        }

        if (!req.isFixed) shuffleArray(orderedSlots);

        let count = 0;
        for (const { day, hour } of orderedSlots) {
          if (count >= req.count) break;
          if (schedule[day][hour] === null && !usedDays.has(day)) {
            schedule[day][hour] = req.name;
            result[req.name].push(`${day} ${hour}시`);
            usedDays.add(day);
            count++;
          }
        }
      }

      return { schedule, result };
    }

    function generateSchedule() {
      const input = document.getElementById("input").value;
      const blocked = document.getElementById("blocked").value;
      const parsed = parseInput(input, blocked);
      const { schedule, result } = assignSchedule(parsed);

      const days = ['월', '화', '수', '목', '금'];
      const hours = Array.from({ length: 9 }, (_, i) => 14 + i);
      let output = '<h3>🗓️ 배정 요약</h3><ul>';
      for (const name in result) {
        const slots = result[name];
        output += `<li>${name}: ${slots.length}회 (${slots.join(', ')})</li>`;
      }
      output += '</ul><h3>📅 시간표</h3><table><thead><tr><th>시간</th>';
      days.forEach(day => output += `<th>${day}</th>`);
      output += '</tr></thead><tbody>';
      hours.forEach(hour => {
        output += `<tr><td>${hour}:00</td>`;
        days.forEach(day => {
          const cell = schedule[day][hour];
          output += `<td class="${cell ? 'highlight' : ''}">${cell || '-'}</td>`;
        });
        output += '</tr>';
      });
      output += '</tbody></table>';
      document.getElementById("output").innerHTML = output;
    }

  
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function assignSchedule(requests) {
      const schedule = {};
      const result = {};
      const debugLog = [];
      const days = ['월', '화', '수', '목', '금'];
      const hours = Array.from({ length: 9 }, (_, i) => 14 + i);

      days.forEach(day => {
        schedule[day] = {};
        hours.forEach(hour => {
          schedule[day][hour] = null;
        });
      });

      requests.sort((a, b) => {
        if (a.isFixed !== b.isFixed) return b.isFixed - a.isFixed;
        const aCount = Object.values(a.availability).reduce((sum, arr) => sum + arr.length, 0);
        const bCount = Object.values(b.availability).reduce((sum, arr) => sum + arr.length, 0);
        if (aCount !== bCount) return aCount - bCount;
        return Math.random() - 0.5;
      });

      for (const req of requests) {
        result[req.name] = [];
        const usedDays = new Set();
        const orderedSlots = [];

        for (const day of days) {
          if (req.availability[day]) {
            req.availability[day].forEach(hour => {
              orderedSlots.push({ day, hour });
            });
          }
        }

        if (!req.isFixed) shuffleArray(orderedSlots);

        let count = 0;
        for (const { day, hour } of orderedSlots) {
          if (count >= req.count) break;
          if (schedule[day][hour] === null && !usedDays.has(day)) {
            schedule[day][hour] = req.name;
            result[req.name].push(`${day} ${hour}시`);
            usedDays.add(day);
            count++;
          }
        }
        debugLog.push(`${req.name} → ${result[req.name].join(', ')}`);
      }

      return { schedule, result, debugLog };
    }

    function generateSchedule() {
      const input = document.getElementById("input").value;
      const blocked = document.getElementById("blocked").value;
      const parsed = parseInput(input, blocked);
      const { schedule, result, debugLog } = assignSchedule(parsed);

      const days = ['월', '화', '수', '목', '금'];
      const hours = Array.from({ length: 9 }, (_, i) => 14 + i);
      let output = '<h3>🗓️ 배정 요약</h3><ul>';
      for (const name in result) {
        const slots = result[name];
        output += `<li>${name}: ${slots.length}회 (${slots.join(', ')})</li>`;
      }
      output += '</ul><h3>📅 시간표</h3><table><thead><tr><th>시간</th>';
      days.forEach(day => output += `<th>${day}</th>`);
      output += '</tr></thead><tbody>';
      hours.forEach(hour => {
        output += `<tr><td>${hour}:00</td>`;
        days.forEach(day => {
          const cell = schedule[day][hour];
          output += `<td class="${cell ? 'highlight' : ''}">${cell || '-'}</td>`;
        });
        output += '</tr>';
      });
      output += '</tbody></table><h3>디버그 로그</h3><pre>' + debugLog.join('\n') + '</pre>';
      document.getElementById("output").innerHTML = output;
    }

  </script>
</head>
<body>
  <div class="container">
    <h1>Physiquezn PT Scheduler Vf5</h1>
    <label for="input">회원별 일정 입력</label>
    <textarea id="input" placeholder="예: 이진우 / 2번 / 월 15, 수 15, 금 16~17"></textarea>
    <label for="blocked">비워야 할 요일 및 시간대 입력 (예: 목 16, 화 14~15)</label>
    <textarea id="blocked" placeholder="예: 목 16, 화 14~15"></textarea>
    <button onclick="generateSchedule()">스케줄 조율</button>
    <div id="output"></div>
  </div>
  <footer>
    Copyright 2025. ZNOO All pictures cannot be copied without permission
  </footer>
</body>
</html>
